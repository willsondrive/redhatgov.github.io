<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Exercise 1.3 - Remove setuid/setgid Binaries | Red Hat | Public Sector</title>

    
    
    <link rel="stylesheet" href="/node_modules/patternfly/dist/css/patternfly.min.css" />
    <link rel="stylesheet" href="/node_modules/patternfly/dist/css/patternfly-additions.min.css" />

    
    <link rel="stylesheet" href="/node_modules/highlight.js/styles/darkula.css" />

    
    <link rel="stylesheet" href="/css/main.css" />
    <link rel="stylesheet" href="/css/asciidoc.css" />
    <link rel="stylesheet" href="/css/custom.css" />
    
    <script id="adobe_dtm" src="//www.redhat.com/dtm.js" type="text/javascript"></script>

    
    <script src="/node_modules/patternfly/node_modules/jquery/dist/jquery.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/bootstrap/dist/js/bootstrap.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/c3/c3.min.js"></script>
    <script src="/node_modules/patternfly/node_modules/d3/d3.min.js"></script>

    
    
    <script src="/node_modules/patternfly/node_modules/datatables/media/js/jquery.dataTables.min.js"></script>
    <script src="/node_modules/patternfly/node_modules/drmonty-datatables-colvis/js/dataTables.colVis.js"></script>
    <script src="/node_modules/patternfly/node_modules/datatables.net-colreorder/js/dataTables.colReorder.js"></script>

    
    
    <script src="/node_modules/patternfly/dist/js/patternfly.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/patternfly-bootstrap-combobox/js/bootstrap-combobox.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/moment/min/moment.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/eonasdan-bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/bootstrap-select/dist/js/bootstrap-select.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/bootstrap-switch/dist/js/bootstrap-switch.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/bootstrap-touchspin/dist/jquery.bootstrap-touchspin.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/patternfly-bootstrap-treeview/dist/bootstrap-treeview.min.js"></script>

    
    <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/jquery-match-height/dist/jquery.matchHeight-min.js"></script>
    
    <script src="/js/clipboard.min.js"></script>
    <script src="/js/clip.js"></script>
    
    <script src="/node_modules/highlight.js/lib/highlight.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </head>
  <body class="">
    

<nav class="navbar navbar-default navbar-inverse navbar-fixed-top " role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">
        <img src="/img/brand.png" alt="Red Hat | Public Sector" />
      </a>
    </div>
    <div class="collapse navbar-collapse navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right">
        
        
          
            <li>
              <a href="/">Home</a>
            </li>
          
        
          
            <li>
              <a href="/about/">About</a>
            </li>
          
        
          
            <li>
              <a href="/contact/">Contact</a>
            </li>
          
        
          
            <li>
              <a href="/events/">Events</a>
            </li>
          
        
          
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                Workshops <b class="caret"></b>
              </a>
              <ul class="dropdown-menu">
                
                  <li>
                    <a href="/workshops/agile_integrations_ci/">Agile Integrations Workshop - Citizen Integrator</a>
                  </li>
                
                  <li>
                    <a href="/workshops/agile_integrations_dev/">Agile Integrations Workshop - Developer</a>
                  </li>
                
                  <li>
                    <a href="/workshops/ansible_tower/">Ansible Tower Workshop</a>
                  </li>
                
                  <li>
                    <a href="/workshops/ansible_tower_azure/">Ansible Tower Workshop on Azure</a>
                  </li>
                
                  <li>
                    <a href="/workshops/cloudforms41/">CloudForms Workshops</a>
                  </li>
                
                  <li>
                    <a href="/workshops/security_containers/">Container Security Workshop</a>
                  </li>
                
                  <li>
                    <a href="/workshops/containers_101/">Containers 101 Workshop</a>
                  </li>
                
                  <li>
                    <a href="/workshops/secure_software_factory/">DevSecOps Workshop - Secure Software Factory</a>
                  </li>
                
                  <li>
                    <a href="/workshops/example/">Example Workshop</a>
                  </li>
                
                  <li>
                    <a href="/workshops/jdv_dev/">JBoss Data Virtualization Development</a>
                  </li>
                
                  <li>
                    <a href="/workshops/strangling_the_monolith/">Microservices Workshop - Strangling the Monolith</a>
                  </li>
                
                  <li>
                    <a href="/workshops/openshift_101_dcmetromap/">OpenShift 101 - DC Metro Map Workshop</a>
                  </li>
                
                  <li>
                    <a href="/workshops/openshift_install/">OpenShift Install</a>
                  </li>
                
                  <li>
                    <a href="/workshops/security_openshift/">OpenShift Security Workshop</a>
                  </li>
                
                  <li>
                    <a href="/workshops/rhosp_101/">Red Hat OpenStack Platform 101</a>
                  </li>
                
                  <li>
                    <a href="/workshops/source_to_image/">Source to Image</a>
                  </li>
                
              </ul>
            </li>
          
        
      </ul>
    </div>
  </div>
</nav>



<div class="jumbotron jumbotron-page text-center">
  <h1>Exercise 1.3 - Remove setuid/setgid Binaries</h1>
</div>

<div class="container">
  <div class="row">
    <p class="text-center">
      
      <a href="http://redhatgov.io/workshops/security_containers">Return to Workshop</a>
    </p>
    
    







<nav>
  <ul class="pager">
    
      <li class="previous">
        <a href="http://redhatgov.io/workshops/security_containers/exercise1.2/">&larr; Previous: Exercise 1.2 - Docker `USER`</a>
      </li>
    
    
      <li class="next">
        <a href="http://redhatgov.io/workshops/security_containers/exercise1.4/">Next: Exercise 1.4 - CGroups &rarr;</a>
      </li>
    
  </ul>
</nav>


    <div id="preamble">
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="/workshops/security_containers/images/code.png" alt="code">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_exercise_1_3_remove_setuidsetgid_binaries">Exercise 1.3 - Remove setuid/setgid Binaries</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_exercise_description">Exercise Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This exercise covers permissions that can be set for setuid and setgid binaries and best practices for managing them.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setuidsetgid_overview">SETUID/SETGID Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are two special permissions that can be set on executable files: Set
User ID (setuid) and Set Group ID (sgid). These permissions allow the file
being executed to be executed with the privileges of the owner or the group.
For example, if a file was owned by the root user and has the setuid bit set,
no matter who executed the file it would always run with root user privileges.</p>
</div>
<div class="paragraph">
<p>Chances are that your application does not need any elevated privileges.
<a href="https://en.wikipedia.org/wiki/Setuid">setuid or setgid</a> binaries. If you can
disable or remove such binaries, you stop any chance of them being used for
<a href="https://en.wikipedia.org/wiki/Buffer_overflow">buffer overruns</a>,
<a href="https://www.owasp.org/index.php/Path_Traversal">path traversal/injection</a> and
<a href="https://en.wikipedia.org/wiki/Privilege_escalation">privilege escalation attacks</a>.</p>
</div>
<div class="sect2">
<h3 id="_step_1_find_a_list_of_binaries">Step 1. Find a list of binaries</h3>
<div class="paragraph">
<p>To get a list of binaries with special permissions in a container image, the following syntax can be used <code>find / -perm +6000 -type f -exec ls -ld {} \;</code>. Note, no need to type this, see next command.</p>
</div>
<div class="listingblock">
<div class="title">Test the latest Debian image</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">sudo docker run debian:jessie find / -perm +6000 -type f -exec ls -ld {} \; 2&gt; /dev/null</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example output</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">-rwsr-xr-x. 1 root root 40000 Mar 29  2015 /bin/mount
-rwsr-xr-x. 1 root root 70576 Oct 28  2014 /bin/ping
-rwsr-xr-x. 1 root root 61392 Oct 28  2014 /bin/ping6
-rwsr-xr-x. 1 root root 40168 May 17  2017 /bin/su
-rwsr-xr-x. 1 root root 27416 Mar 29  2015 /bin/umount
-rwxr-sr-x. 1 root shadow 35408 May 27  2017 /sbin/unix_chkpwd
-rwxr-sr-x. 1 root shadow 62272 May 17  2017 /usr/bin/chage
-rwsr-xr-x. 1 root root 53616 May 17  2017 /usr/bin/chfn
-rwsr-xr-x. 1 root root 44464 May 17  2017 /usr/bin/chsh
-rwxr-sr-x. 1 root shadow 22744 May 17  2017 /usr/bin/expiry
-rwsr-xr-x. 1 root root 75376 May 17  2017 /usr/bin/gpasswd
-rwsr-xr-x. 1 root root 39912 May 17  2017 /usr/bin/newgrp
-rwsr-xr-x. 1 root root 54192 May 17  2017 /usr/bin/passwd
-rwxr-sr-x. 1 root tty 27232 Mar 29  2015 /usr/bin/wall</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_step_2_defang_the_binaries">Step 2. "Defang" the binaries</h3>
<div class="paragraph">
<p>You can then “defang” the binaries with <code>chmod a-s</code> to remove the suid bit.
For example, you can create a defanged Debian image with the following Dockerfile:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cd ~</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">mkdir ~/defanged-debian</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cd ~/defanged-debian</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">vim Dockerfile</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_step_3_copy_the_dockerfile_text_below_and_paste_it_into_the_terminal_window">Step 3. Copy the Dockerfile text below and paste it into the terminal window.</h3>
<div class="paragraph">
<p>Press <code>i</code> for Insert, then cut and paste <code>control + v</code>, then escape and write the file <code>esc</code>, <code>:wq</code>.</p>
</div>
<div class="listingblock">
<div class="title">Dockerfile</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">FROM debian:jessie
RUN find / -xdev -perm +6000 -type f -exec chmod a-s {} \; || true</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>|| true</code> allows you to ignore any errors from find. The setuid and setgid
binaries run with the privileges of the owner rather than the user. These are
normally used to allow users to temporarily run with escalated privileges
required to execute a given task, such as setting a password.</p>
</div>
</div>
<div class="sect2">
<h3 id="_step_4_build_the_image">Step 4. Build the Image</h3>
<div class="paragraph">
<p>Build the new image.</p>
</div>
<div class="listingblock">
<div class="title">Build the image</div>
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">sudo docker build -t defanged-debian .</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_step_5_test_the_image">Step 5. Test the image</h3>
<div class="paragraph">
<p><strong>Now Test it to see that it has been changed.</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">sudo docker run --rm defanged-debian \
  find / -perm +6000 -type f -exec ls -ld {} \; 2&gt; /dev/null | wc</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_step_6_run_the_command_on_your_rhel_host">Step 6. Run the command on your RHEL host</h3>
<div class="paragraph">
<p>For comparison, now do the same command on your RHEL host, with a slight modification for the most recent version of findutils.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">sudo find / -perm /6000 -type f -exec ls -ld {} \; 2&gt; /dev/null | wc</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s more likely that your Dockerfile will rely on a setuid/setgid binary than
your application. Therefore, you can always perform this step near the end,
after any such calls and before changing the user (removing setuid binaries is
pointless if the application runs with root privileges).</p>
</div>
<div class="paragraph">
<p><a href="https://access.redhat.com/solutions/33826">SUID+SGID+Sticky Bit</a>
<hr>
<h3>Workshop Details</h3>
<div class="row">
  <div class="col-lg-4 col-md-5 col-sm-12" id="workshopFooterDetails">
    <table>
      <tr>
        <td class="text-right"><b>Domain</b></td>
        <td><span class="domain"></span></td>
        <td rowspan="3">
          <img src="https://www.redhat.com/files/brand/email/sig-redhat.png" alt="Red Hat Logo" />
        </td>
      </tr>
      <tr>
        <td class="text-right"><b>Workshop</b></td>
        <td><span class="prefix"></span></td>
      </tr>
      <tr>
        <td class="text-right"><b>Student ID</b></td>
        <td><span class="userid"></span></td>
      </tr>
    </table>
  </div>
  <div class="col-lg-8 col-md-7 col-sm-12">
    <form id="footerForm" onsubmit="return false;" class="row" style="padding: 1.75rem 0 0 0;">
      <div class="form-group col-sm-6 col-md-6 col-lg-2">
        <label for="userid">Student ID</label>
        <select id="userid" name="userid" class="form-control">
          <option value="0">0</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
          <option value="10">10</option>
          <option value="11">11</option>
          <option value="12">12</option>
          <option value="13">13</option>
          <option value="14">14</option>
          <option value="15">15</option>
          <option value="16">16</option>
          <option value="17">17</option>
          <option value="18">18</option>
          <option value="19">19</option>
          <option value="20">20</option>
          <option value="21">21</option>
          <option value="22">22</option>
          <option value="23">23</option>
          <option value="24">24</option>
          <option value="25">25</option>
          <option value="26">26</option>
          <option value="27">27</option>
          <option value="28">28</option>
          <option value="29">29</option>
          <option value="30">30</option>
          <option value="31">31</option>
          <option value="32">32</option>
          <option value="33">33</option>
          <option value="34">34</option>
          <option value="35">35</option>
          <option value="36">36</option>
          <option value="37">37</option>
          <option value="38">38</option>
          <option value="39">39</option>
          <option value="40">40</option>
          <option value="41">41</option>
          <option value="42">42</option>
          <option value="43">43</option>
          <option value="44">44</option>
          <option value="45">45</option>
          <option value="46">46</option>
          <option value="47">47</option>
          <option value="48">48</option>
          <option value="49">49</option>
          <option value="50">50</option>
        </select>
      </div>
      <div class="form-group col-sm-6 col-md-6 col-lg-4">
        <label for="domain">Domain</label>
        <select id="domain" name="domain" class="form-control">
          <option value="redhatgov.io">redhatgov.io</option>
          <option value="az.redhatgov.io">az.redhatgov.io</option>
          <option value="redhat-fierce.io">redhat-fierce.io</option>
          <option value="fiercesw.network">fiercesw.network</option>
          <option value="rhtps.io">rhtps.io</option>
          <option value="openshiftworkshop.com">openshiftworkshop.com</option>          
          <option value="redhatpsmwsa.com">redhatpsmwsa.com</option>          
        </select>
      </div>
      <div class="form-group col-sm-6 col-md-6 col-lg-3">
        <label for="prefix">Workshop</label>
        <input id="prefix" name="prefix" type="text" size="16" class="form-control" placeholder="example" />
      </div>
      <div class="form-group col-sm-6 col-md-6 col-lg-3">
        <button type="submit" class="btn btn-primary form-control" style="margin-bottom:1rem;">Enter</button>
        <button type="reset" class="btn btn-default form-control">Default</button>
      </div>
    </form>
  </div>
</div>

<hr>

<script type="text/javascript" src="/node_modules/js-cookie/src/js.cookie.js"></script>
<script type="text/javascript">
<!--
  
  var Cookies2 = Cookies.noConflict();

  var cookiePathArr = cleanArray(window.location.pathname.split('/'));
  var cookiePath = '/' + cookiePathArr[0] + '/' + cookiePathArr[1] + '/';

  function cleanArray(actual) {
    var newArray = new Array();
    for (var i = 0; i < actual.length; i++) {
      if (actual[i]) {
        newArray.push(actual[i]);
      }
    }
    return newArray;
  }
  function replaceClassText() {
    jQuery("span.domain").html(Cookies2.get("domain"));
    jQuery("span.userid").html(Cookies2.get("userid"));
    jQuery("span.prefix").html(Cookies2.get("prefix"));
  }
  function pageLoadWorkshopFooterTest() {
    
    if (Cookies2.get("domain") === undefined) {
      resetWorkshopFooter();
    }
    else {
      replaceClassText();
      setWorkshopFooterInputValues()
    }
  }
  function setWorkshopFooterData() {
    
    Cookies2.set("domain", jQuery("select#domain").val(), { path: cookiePath, expires: 7 } );
    Cookies2.set("prefix", jQuery("input#prefix").val(), { path: cookiePath, expires: 7 } );
    Cookies2.set("userid", jQuery("select#userid").val(), { path: cookiePath, expires: 7 } );
    replaceClassText();
  }
  function setWorkshopFooterInputValues() {
    jQuery("select#domain").val(Cookies2.get("domain"));
    jQuery("input#prefix").val(Cookies2.get("prefix"));
    jQuery("select#userid").val(Cookies2.get("userid"));
  }
  function resetWorkshopFooter() {
    
    jQuery("select#domain, select#userid").prop("selectedIndex", 0);
    jQuery("input#prefix").val(jQuery("input#prefix").attr('placeholder'));
    
    Cookies2.set("domain", jQuery("select#domain option").first().val(), { path: cookiePath, expires: 7 } ); 
    Cookies2.set("userid", jQuery("select#userid option").first().val(), { path: cookiePath, expires: 7 } ); 
    Cookies2.set("prefix", jQuery("input#prefix").val(), { path: cookiePath, expires: 7 } );
    
    
    replaceClassText();
  }

  jQuery(document).ready(function() {
    pageLoadWorkshopFooterTest();

    jQuery("form#footerForm").submit(function() {
      setWorkshopFooterData();
      return false; 
    });

    jQuery("form#footerForm").bind("reset", function() {
      resetWorkshopFooter();
      return true;
    });

    return false;
  });
-->
</script>

</p>
</div>
</div>
</div>
</div>


    







<nav>
  <ul class="pager">
    
      <li class="previous">
        <a href="http://redhatgov.io/workshops/security_containers/exercise1.2/">&larr; Previous: Exercise 1.2 - Docker `USER`</a>
      </li>
    
    
      <li class="next">
        <a href="http://redhatgov.io/workshops/security_containers/exercise1.4/">Next: Exercise 1.4 - CGroups &rarr;</a>
      </li>
    
  </ul>
</nav>


    <p class="text-center">
      
      <a href="http://redhatgov.io/workshops/security_containers">Return to Workshop</a>
    </p>
  </div>
</div>

    <div id="page-footer" class="container">
      <p class="text-center">
        Copyright &copy; 2019 Red Hat, Inc.
      </p>
    </div>
    <script type="text/javascript">
      if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
          _satellite.pageBottom();
      }
    </script>
  </body>
</html>

